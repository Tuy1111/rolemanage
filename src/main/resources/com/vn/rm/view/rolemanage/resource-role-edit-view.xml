<view xmlns="http://jmix.io/schema/flowui/view"
      title="msg://resourceRoleEditView.title">

    <data>
        <instance id="roleModelDc" class="io.jmix.security.model.ResourceRoleModel">
            <fetchPlan extends="_base">
                <property name="resourcePolicies" fetchPlan="_base"/>
            </fetchPlan>
            <collection id="resourcePoliciesDc" property="resourcePolicies"/>
        </instance>

        <!-- Ma trận quyền theo entity -->
        <collection id="entityMatrixDc"
                    class="com.vn.rm.view.rolemanage.entityfragment.EntityMatrixRow"/>
        <collection id="childRolesDc"
                    class="io.jmix.security.model.ResourceRoleModel"/>

        <!-- Tree UI/Menu -->
        <collection id="policyTreeDc"
                    class="com.vn.rm.view.rolemanage.userinterfacefragment.PolicyGroupNode" />

<?xml version="1.0" encoding="UTF-8"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="msg://rm_ResourceRoleEditView.title"
      focusComponent="formRole">

    <data>
        <instance id="roleModelDc" class="io.jmix.security.model.ResourceRoleModel">
            <collection id="resourcePoliciesDc" property="resourcePolicies"/>
        </instance>
        <collection id="policyTreeDc" class="com.vn.rm.entity.PolicyGroupNode"/>
    </data>

    <facets>
        <settings auto="true"/>
        <dataLoadCoordinator auto="true"/>
    </facets>

    <actions>
        <action id="saveAction" type="detail_saveClose"/>
        <action id="closeAction" type="detail_close"/>
    </actions>

    <!-- Mở rộng theo tabsheet -->
    <layout expand="permissionsTabs">
        <vbox id="contentBox" width="100%" padding="false" spacing="false">
            <formLayout id="form" dataContainer="roleModelDc" width="100%">
                <textField id="nameField" property="name" required="true" themeNames="small"/>
                <textField id="sourceField" property="source" readOnly="true" themeNames="small"/>
                <textField id="codeField" property="code" readOnly="true" themeNames="small"/>
                <checkboxGroup id="scopesField" property="scopes" required="true"
                               themeNames="small helper-above-field"/>
                <textArea id="descriptionField" property="description" height="6em" themeNames="small"/>
            </formLayout>
        </vbox>

        <!-- Tabsheet chứa 2 fragment: matrix + tree -->
        <tabSheet id="permissionsTabs" width="100%" height="100%">
            <tab id="entitiesTab" label="Entities &amp; Attributes">
                <vbox id="entitiesTabContent"
                      width="100%" height="100%"
                      expand="entitiesFragment">
                    <fragment id="entitiesFragment"
                              class="com.vn.rm.view.rolemanage.entityfragment.EntitiesFragment"/>
                </vbox>
            </tab>

            <tab id="uiTab" label="UI &amp; Menus">
                <vbox id="uiTabContent"
                      width="100%" height="100%"
                      expand="userInterfaceFragment">
                    <fragment id="userInterfaceFragment"
                              class="com.vn.rm.view.rolemanage.userinterfacefragment.UserInterfaceFragment"/>
                </vbox>
            </tab>
        </tabSheet>

        <!-- Actions -->
        <hbox id="detailActions" classNames="px-m py-s bg-contrast-5">
            <button id="saveAndCloseBtn" action="saveAction"/>
            <button id="closeBtn" action="closeAction"/>
        </hbox>

    <layout alignItems="STRETCH" padding="false" spacing="false">

        <vbox id="roleBox" padding="true" spacing="true">
            <h3>Role Information</h3>
            <formLayout id="formRole" dataContainer="roleModelDc">
                <textField id="nameField" property="name"/>
                <textField id="codeField" property="code" readOnly="true"/>
                <textField id="sourceField" property="source" readOnly="true"/>
                <checkboxGroup id="scopesField" property="scopes"/>
                <textArea id="descriptionField" property="description" height="7em"/>
            </formLayout>
        </vbox>

        <vbox id="policyBox" padding="true" spacing="true">
            <hbox spacing="true" alignItems="CENTER">
                <checkbox id="showAssignedOnly" label="Show Assigned Only"/>
                <checkbox id="allowAllViews" label="Allow all views"/>
            </hbox>

            <h3>Resource Policies (Tree)</h3>
            <treeDataGrid id="policyTreeGrid"
                          dataContainer="policyTreeDc"
                          hierarchyProperty="parent"
                          width="100%"
                          minHeight="35em"/>
        </vbox>

        <hbox id="detailActions" justifyContent="END" spacing="true"
              classNames="px-m py-s bg-contrast-5">
            <button id="saveBtn" themeNames="primary success" text="Save"/>
            <button id="closeBtn" themeNames="tertiary error" text="Close"/>
        </hbox>


    </layout>
</view>
